import{j as o,c as F,r as f,i as H}from"./index-BrX1-YwQ.js";import{d as S,E as M,f as L,C as u,b as I,e as W}from"./constants-BNam4_mG.js";import{C as q,S as z}from"./Show_Group_Tile-DV3vZFAf.js";import{n as K,o as Q,p as V}from"./db-mkYCc2gH.js";import{T as X}from"./trash-BnpXJPEK.js";import{A as Y}from"./Ensemble_Section_Tile-DY5QyTXH.js";function Z({actor:g,canDelete:G,onDelete:w}){return o.jsx("div",{className:"ActorTile",id:"actor-tile-"+g.userId,children:o.jsxs("div",{className:"header",children:[o.jsx("div",{className:"ActorNameDiv",children:o.jsxs("label",{htmlFor:"Actor",children:["Actor: ",g.name]})}),G&&o.jsx("div",{className:"ActorTrashDiv",children:o.jsx("img",{src:X,alt:"",className:"TrashIcon",onClick:()=>{w()}})})]})})}F(document.getElementById("root")).render(o.jsx(f.StrictMode,{children:o.jsx(_,{})}));function _(){const[g,G]=f.useState(""),[w,R]=f.useState(""),[n,y]=f.useState(),[m,N]=f.useState([]),[p,v]=f.useState([]),[J,C]=f.useState(!1),[x,T]=f.useState([]),[A,b]=f.useState([]),[k,E]=f.useState(!1),j=f.useRef(null),[D,B]=f.useState(!1);async function P(){let l=!0;if(C(!0),!n){C(!1);return}for(let a=0;a<n.characters.length;a++){const s=n.characters[a],e=m.find(t=>t.name==s.name);e&&(console.log("New Character"),console.log(e),n.characters[a]=e,e.actor==null&&(console.log("Actor is null"),l=!1))}for(let a=0;a<n.showGroups.length;a++){console.log("UPDATING SHOW GROUPS");const s=n.showGroups[a];console.log("Show Group: "+s.name);const e=p.find(t=>t.name==s.name);if(console.log("New Show Group: "+(e==null?void 0:e.name)),e){s.characters=e.characters;for(let t=0;t<s.characters.length;t++){const c=s.characters[t];if(c instanceof u){const r=m.find(i=>i.name==c.name);r&&(s.characters[t]=r,r.actor==null&&(l=!1))}}}}for(let a=0;a<n.layout.length;a++){const s=n.layout[a];for(let e=0;e<s.scenes.length;e++){const t=s.scenes[e];for(let c=0;c<t.characters.length;c++){const r=t.characters[c];if(r instanceof u){const i=m.find(h=>h.name==r.name);i&&(t.characters[c]=i)}else if(r instanceof I){const i=p.find(h=>h.name==r.name);if(i){for(let h=0;h<i.characters.length;h++){const d=i.characters[h];if(d instanceof u){const O=m.find(U=>U.name==d.name);O&&(i.characters[h]=O)}}t.characters[c]=i}}}}}for(let a=0;a<n.songs.length;a++){const s=n.songs[a];console.log("Assigning roles to song"),console.log(s);for(let e=0;e<s.characters.length;e++){const t=s.characters[e];if(console.log("Character"),console.log(t),console.log(typeof t),t instanceof u){const c=m.find(r=>r.name==t.name);c&&(s.characters[e]=c)}else if(t instanceof I){const c=p.find(r=>r.name==t.name);if(c){for(let r=0;r<c.characters.length;r++){const i=c.characters[r];if(i instanceof u){const h=m.find(d=>d.name==i.name);h&&(c.characters[r]=h)}}s.characters[e]=c}}console.log("New Character"),console.log(s.characters[e]),console.log(typeof s.characters[e])}}for(let a=0;a<n.dances.length;a++){const s=n.dances[a];for(let e=0;e<s.characters.length;e++){const t=s.characters[e];if(t instanceof u){const c=m.find(r=>r.name==t.name);c&&(s.characters[e]=c)}else if(t instanceof I){const c=p.find(r=>r.name==t.name);if(c){for(let r=0;r<c.characters.length;r++){const i=c.characters[r];if(i instanceof u){const h=m.find(d=>d.name==i.name);h&&(c.characters[r]=h)}}s.characters[e]=c}}}}if(n.canCreateSchedule=l,n.ensemble=W.fromBlank(A,Date.now()),n.isCreatingSchedule){if(!l){alert("Cannot update show because not all characters have been assigned actors"),C(!1);return}await Q(n)}y(n),console.log(n.toMap()),console.log("Can create schedule"),console.log(l),localStorage.setItem("show-"+w,JSON.stringify(n)),await V(g,w,n),C(!1)}return f.useEffect(()=>{var t;H(()=>{}),E(!0);const l=new URLSearchParams(window.location.search),a=l.get("activityId");a&&(G(a),K(a).then(c=>{T(c),console.log(c),E(!1)}));const s=l.get("showId");s&&R(s);const e=localStorage.getItem("show-"+s);if(e){console.log(JSON.parse(e)),y(S.fromMap(JSON.parse(e))),console.log(S.fromMap(JSON.parse(e))),N(S.fromMap(JSON.parse(e)).characters),v(S.fromMap(JSON.parse(e)).showGroups);const c=S.fromMap(JSON.parse(e)).showGroups;let r=!1;for(let i=0;i<c.length;i++)c[i].characters.map(d=>d instanceof M).includes(!0)&&(r=!0);B(r),(t=JSON.parse(e))!=null&&t.hasEnsemble&&b(S.fromMap(JSON.parse(e)).ensemble.actors)}},[]),o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"title",children:o.jsx("h1",{children:"Assign Roles"})}),o.jsxs("div",{className:"center",children:[o.jsx("h2",{children:"Assign Characters"}),o.jsx("div",{className:"characters",id:"create-characters",children:m.map((l,a)=>o.jsx(q,{character:l,actors:x,characters:[],isAssign:!0,setCharacter:s=>{N(e=>{const t=[...e];return t[a]=s,t})},removeCharacter:()=>{N(m.filter((s,e)=>e!==a))},isCreate:!1},a))}),D&&o.jsxs(o.Fragment,{children:[o.jsx("h2",{children:"Assign Show Groups"}),o.jsx("div",{className:"showGroups",id:"create-showGroups",children:p.map((l,a)=>l.characters.map(s=>s instanceof M).includes(!0)?o.jsx(z,{showGroup:l,showGroups:[],hasEnsemble:!1,characters:m,actors:x,isAssign:!0,setShowGroup:s=>{v(e=>{const t=[...e];t[a]=s,console.log("NEW SHOW GROUPS");for(let c=0;c<t.length;c++){const r=t[c];console.log(r.toMap())}return t})},removeShowGroup:()=>{v(p.filter((s,e)=>e!==a))},isCreate:!1},a):null)})]}),(n==null?void 0:n.hasEnsemble)&&o.jsxs(o.Fragment,{children:[o.jsx("h2",{children:"Assign Ensemble"}),o.jsx("div",{className:"ensemble",id:"create-ensemble",children:A.map((l,a)=>(console.log(l),o.jsx(Z,{actor:l,canDelete:!0,onDelete:()=>{b(A.filter((s,e)=>e!==a))}},a)))}),o.jsx("button",{className:"ActionBtn",onClick:()=>{var l;(l=j.current)==null||l.showModal()},children:"Add Actor"})]}),J?o.jsx("div",{className:"loader"}):o.jsx("button",{className:"ActionBtn",onClick:async()=>{await P(),window.location.href="/Activity/Shows/Show/?activityId="+g+"&showId="+w},children:"Save"}),o.jsx("button",{className:"ActionBtn",onClick:()=>{window.location.href="/Activity/Shows/Show/?activityId="+g+"&showId="+w},children:"Back"})]}),(n==null?void 0:n.hasEnsemble)&&!k&&o.jsx(Y,{dialogRef:j,keepPastResult:!1,actor:new L,addedActors:A,actors:x,setActor:l=>{var s;const a=[...A];a.push(l),console.log("Setting actors"),b(a),(s=j.current)==null||s.close()},close:()=>{var l;(l=j.current)==null||l.close()}})]})}
